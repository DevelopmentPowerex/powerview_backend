<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe Periódico | PowerView</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    brand: {
                        50: '#eef7ff',
                        100: '#d9ecff',
                        200: '#aedaff',
                        300: '#7cc2ff',
                        400: '#4aa6ff',
                        500: '#1f86ff',
                        600: '#1068db',
                        700: '#0b50ad',
                        800: '#0a3e85',
                        900: '#082f66'
                    }
                },
                fontFamily: {
                    sans: ["Inter", "ui-sans-serif", "system-ui", "Segoe UI", "Roboto", "Helvetica", "Arial", "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"]
                }
            }
        }
    }
    </script>
    <style>
        @page{
            size: A4;
            margin: 20mm;
        }
        @media print {
            .content-wrapper {
                padding-top: 25mm;   /* mismo espacio reservado que el header */
                padding-bottom: 20mm; /* espacio para footer */
            }
            header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 20mm;
            }
            footer {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 15mm;
            }
            body {
                margin-top: 0mm;  /* compensar espacio para el header */
                margin-bottom: 0mm; /* compensar espacio para el footer */
            }
            .page-break {
                page-break-after: always;
            }
            /* Evitar que las tablas se dividan entre páginas */
            table table, thead, tbody, tr, td, th{
                page-break-inside: avoid !important;
            }
    
            /* Asegurar que los encabezados no queden solos al final de página */
            h1, h2, h3, h4, h5, h6 {
                page-break-after: avoid;
            }
            /* Numeración automática de páginas */
            .page-number:after {
                content: counter(page);
            }
            .grid-item{
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
        }
        
        /* Estilos para visualización en navegador */
        @media screen {
            body {
                background-color: #f3f4f6;
                padding: 20px;
            }
            .container {
                max-width: 210mm;
                margin: 0 auto;
                background: white;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                padding: 20mm;
            }
        }
        
        /* Estilos generales */
        body {
            font-family: "Inter", sans-serif;
            color: #1e293b;
        }
        
    </style>
</head>

<body>
    <!-- HEADER -->
    <header class="header flex justify-between items-center border-b border-slate-200 px-8 py-3 bg-white">
    <div class="flex items-center">
        <img src="/OnDemand/report_generator/static/img/loguito.png" 
            alt="PowerView" class="h-6 mr-3">
        <p>Proyecto: <span class="text-md font-semibold"> {{project_info.project_name}}</span></p>
        
    </div>
    <div class="text-right text-sm text-slate-500">
        <p><b>Cliente: </b>{{project_info.client_name}}</p>
        <p><b>Fecha de generación: </b>{{report_info.gen_date}}</p>
    </div>
    </header>

    <!-- PORTADA -->
    <div class="min-h-screen flex flex-col items-center justify-center">
        <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight text-slate-900 text-center mt-6">INFORME PERIÓDICO</h1>
        <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight text-slate-900 text-center mt-6">{{project_info.project_name}}</h1>
        <p class="mt-4 text-lg text-slate-600 text-center mb-10">Detalles del sistema eléctrico monitoreado por PowerView</p>
        
        <div class="mt-10 grid grid-cols-3 md:grid-cols-3 gap-4 mb-12">
            <div class="p-4 rounded-sm border border-slate-200">
                <p class="text-xs uppercase tracking-wider text-slate-500">Cliente</p>
                <p class="font-medium">{{project_info.client_name}}</p>
            </div>
            <div class="p-4 rounded-sm border border-slate-200">
                <p class="text-xs uppercase tracking-wider text-slate-500">Proyecto</p>
                <p class="font-medium">{{project_info.project_name}}</p>
            </div>
            <div class="p-4 rounded-sm border border-slate-200">
                <p class="text-xs uppercase tracking-wider text-slate-500">Circuitos Monitoreados</p>
                {% for circuit in circuits_list%}
                    <p class="font-medium">{{circuit.name}}</p>
                {%endfor%}
            </div>
            <div class="p-4 rounded-sm border border-slate-200">
                <p class="text-xs uppercase tracking-wider text-slate-500">Rango de fechas</p>
                <p class="font-medium">{{report_info.date_range_start}} - {{report_info.date_range_end}}</p>
            </div>
            <div class="p-4 rounded-sm border border-slate-200">
                <p class="text-xs uppercase tracking-wider text-slate-500">Medidores utilizados</p>
                {% for meter in project_info.meters_list %}
                    <p class="font-medium">{{meter}}</p>
                {%endfor%}
            </div>
            <div class="p-4 rounded-sm border border-slate-200">
                <p class="text-xs uppercase tracking-wider text-slate-500">Emitido por</p>
                <p class="font-medium">{{project_info.fae.company_name}}</p>
            </div>
        </div>
        
        <div class="flex justify-center gap-12">
            <img src="/OnDemand/report_generator/static/img/logo_powerview.png" alt="POWEREX" class="w-full h-auto max-h-20 object-contain"/>
        </div>
    </div>

    <main class="container">

        <p class="mt-4 text-slate-700 leading-relaxed text-sm">
        Los datos adjuntos en este informe fueron obtenidos a través del sistema de monitoreo y telemetría PowerView©. Este es un informe automatizado que incluye los detalles más relevantes del
        sistema eléctrico dentro de las fechas solicitadas.
        </p> 
        
        <section> <!-- LECTURA DE PARAMETROS -->
            <h2 class=" mt-4 text-2xl font-bold text-slate-900">1. Resumen de parámetros de cada circuito</h2>
            
            <p class="mt-4 text-sm text-slate-600">Valores máximo, mínimo y promedio para cada uno de los parametros eléctricos leídos dentro del rango de tiempo del informe.</p>

            {% for circuit in circuits_list %}
                <div section>
                <h3 class="text-xl font-bold text-slate-900 mt-4">{{circuit.name}}</h3>
                <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                    {% for parameter,values in circuit.parameters_list.items() %}
                        <div class="grid-item p-4 rounded-sm ring-1 ring-slate-200">
                            <p class="text-xs uppercase tracking-wider text-slate-500">{{parameter}}</p>
                            <p class="mt-1 text-3xl font-extrabold">———</p>
                                
                            <div class="mt-4 overflow-hidden rounded-sm ring-1 ring-slate-200">   
                                <table class="w-full border-collapse text-sm text-center">
                                    <thead class="bg-slate-50">
                                        <tr>
                                            <th class="font-semibold p-1">-</th>
                                            <th class="font-semibold p-1">Max</th>
                                            <th class="font-semibold p-1">Min</th>
                                            <th class="font-semibold p-1">Prom</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        {% for value in values%}
                                            <tr class="odd:bg-white even:bg-slate-50">
                                                <td class="p-1"><b>{{value.name}}</b></td>
                                                <td class="p-1">{{value.max}}</td>
                                                <td class="p-1">{{value.min}}</td>
                                                <td class="p-1">{{value.prom}}</td>
                                            </tr>
                                        {%endfor%}
                                    </tbody>
                                </table>
                            </div>
                        
                        </div>
                    {% endfor %}
                </div>
                
            </div>
            {%endfor%}
        </section>
       
        <section> <!-- GRAFICAS COMPORTAMIENTO -->
            <h2 class="text-2xl font-bold text-slate-900 mt-4">2. Gráficas de comportamiento</h2>
            <p class="mt-4 text-slate-700 leading-relaxed text-sm">
            En las siguientes gráficas se puede revisar el comportamiento que han tenido los parámetros eléctricos de los circuitos monitoreados de {{project_info.project_name}}
            </p>  
            
            {% for circuit in circuits_list %}
                <div section>
                
                    <h3 class="text-xl font-bold text-slate-900 mt-4">{{circuit.name}}</h3>
                    <div class="mt-4 grid grid-cols-1 sm:grid-cols-1 lg:grid-cols-1 gap-4">
                        {% for graph in circuit.behaviour_images %}
                            <div class="grid-item p-4 rounded-sm ring-1 ring-slate-200">
                                <p class="text-xs uppercase tracking-wider text-slate-500 mt-4">{{graph.name}}</p>
                                <p class="mt-1 text-3xl font-extrabold">———</p>
                                <img src="{{graph.image}}" alt="{{graph.name}}" class="w-full h-auto max-h-auto object-contain"/>
                            </div> 
                        {% endfor %}
                    </div>

                </div> 
            
            {% endfor %}

        </section>
   
        <section> <!-- TABLA ALARMAS -->
            <h2 class="mt-4 text-2xl font-bold text-slate-900">3. Alarmas ocurridas</h2>
            <p class="mt-4 text-sm text-slate-600">
                En caso de haberse presentado alguna eventualidad, esta fue notificada oportunamente a 
                través del sistema automatizado de monitoreo. El registro de los eventos ocurridos es el siguiente.
            </p>
            {% if events %}
                <div class="mt-4 overflow-hidden rounded-sm ring-1 ring-slate-200">   
                    <table class="w-full border-collapse text-sm text-center">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="font-semibold p-3">#</th>
                                <th class="font-semibold p-3">Circuito</th>
                                <th class="font-semibold p-3">Contexto</th>
                                <th class="font-semibold p-3">Regla rota</th>
                                <th class="font-semibold p-3">Primer evento</th>
                                <th class="font-semibold p-3">Último evento</th>
                                <th class="font-semibold p-3">Cantidad de incidencias</th>
                                <th class="font-semibold p-3">Severidad</th>
                            </tr>
                        </thead>
                    <tbody>
                        {%for event in events%}
                            <tr>
            
                                <td class="p-3">{{loop.index}}</td>
                                <td class="p-3">{{event.circuit}}</td>
                                <td class="p-3">{{event.context}}</td>
                                <td class="p-3">{{event.rule}}</td>
                                <td class="p-3">{{event.first_event| replace("T", " ")}}</td>
                                <td class="p-3">{{event.last_event| replace("T", " ")}}</td>
                                <td class="p-3">{{event.event_counter}}</td>
                                {%if event.level == "CRITICAL"%}
                                    <td class="bg-red-600 p-3">CRITICA</td>
                                {%elif event.level == "MID"%}  
                                    <td class="bg-orange-500 p-3">MEDIA</td>
                                {%elif event.level == "LOW"%}  
                                    <td class="bg-yellow-300 p-3">BAJA</td>
                                {%endif%}
                                
                            </tr>
                        {%endfor%}
                    </tbody>
                    </table>
                </div>
            {%else%}
            <p class="mt-4 text-slate-500 italic">No se registraron alarmas en el periodo.</p>
            {%endif%}
        </section>
       
        <div class="page-break"></div>
        <section><!-- ANEXOS Y CIERRE -->
            <h2 class="mt-4 text-2xl font-bold text-slate-900">5. Anexos</h2>
            <p class="mt-4 text-sm text-slate-600">En los siguientes archivos podrá encontrar la información completa que fue resumida en este informe.</p>
            <ul class="mt-4 list-disc pl-6 text-slate-700 text-sm">
                <li>Registro completo de las mediciones: {{report_info.csv}}.csv</li>
                
                {%if events%}
                <li>Registro de alarmas emitidas: {{report_info.csv}}_eventos.csv</li>
                {%endif%}

            </ul><!-- Mensaje final -->
            <div class="mt-16 flex items-center justify-center gap-3 text-sm text-slate-500">
                <div>
                    <p class="mt-4 text-slate-700 leading-relaxed">
                        En caso de necesitar mayor explicación o detalle de lo incluido en este informe, por favor comuniquese con su provedor de servicio <b>{{project_info.fae.company_name}}</b>
                    </p>
                    <p class="mt-4 text-slate-700 leading-relaxed">
                        <b>Técnico Responsable: </b>
                    </p>
                    <p>{{project_info.fae.engineer_name}}</p>
                    <p>{{project_info.fae.email_addr}}</p>
                    <p>{{project_info.fae.phone}}</p>
                </div>
            </div>
        </section>

    </main>

    <!-- FOOTER -->
    <footer class="footer flex justify-between items-center border-t border-slate-200 px-8 py-2 bg-white text-xs text-slate-500">
        <p>© PowerView by Powerex - Developed by Corso Insight Solutions</p>
        <!--<p>Página <span class="page-number"></span></p>-->
    </footer>
    
</body>

</html>